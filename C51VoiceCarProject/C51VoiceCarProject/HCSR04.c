#include "HCSR04.h"

/********************************变量定义****************************************/
unsigned int time;
float dis;

/******************************************************************************/
/* 函数名称  : HSCR04_Init      	        		  	      	               	  */
/* 函数描述  : 初始化超声波测距，时间和距离									  */	
/* 输入参数  : 无	                                                          */
/* 参数描述  : 无					                       		              */
/* 返回值    : 无			                                                  */
/******************************************************************************/
void HSCR04_Init()
{
	time = 0;
	dis = 0.0;
}

/******************************************************************************/
/* 函数名称  : Timer2_Init      	        		  	      	               	  */
/* 函数描述  : 初始化定时器2，测时使用										  */	
/* 输入参数  : 无	                                                          */
/* 参数描述  : 无					                       		              */
/* 返回值    : 无			                                                  */
/******************************************************************************/
void Timer2_Init()
{
	T2CON = 0;
	TL2 = 0;		//设置定时初值
	TH2 = 0;		//设置定时初值
}  

/******************************************************************************/
/* 函数名称  : Trig_Init      	        		  	      	               	  */
/* 函数描述  : 超声波测距的触发条件											  */	
/* 输入参数  : 无	                                                          */
/* 参数描述  : 无					                       		              */
/* 返回值    : 无			                                                  */
/******************************************************************************/
void Trig_Init()
{
	Trig = LOW;
	Trig = HIGH;
	Delay10us();
	Trig = LOW;
}

/******************************************************************************/
/* 函数名称  : Start_Time      	        		  	      	               	  */
/* 函数描述  : 开始计时初始化												  */	
/* 输入参数  : 无	                                                          */
/* 参数描述  : 无					                       		              */
/* 返回值    : 无			                                                  */
/******************************************************************************/
void Start_Time()
{
	TH2 = 0;
	TL2 = 0;
	TR2 = 1;
}

/******************************************************************************/
/* 函数名称  : End_Time      	        		  	      	               	  */
/* 函数描述  : 结束计时，关闭定时器2											  */	
/* 输入参数  : 无	                                                          */
/* 参数描述  : 无					                       		              */
/* 返回值    : 无			                                                  */
/******************************************************************************/
void End_Time()
{
	TR2 = 0;
}

/******************************************************************************/
/* 函数名称  : Get_Time      	        		  	      	               	  */
/* 函数描述  : 计算超声波发射出去和反射回来所使用的时间						  */	
/* 输入参数  : 无	                                                          */
/* 参数描述  : 无					                       		              */
/* 返回值    : 无			                                                  */
/******************************************************************************/
float Get_Time()
{
	unsigned int time = 0;
	time = TH2 << 8 | TL2;
	return time;
}
 
/******************************************************************************/
/* 函数名称  : Get_Dis      	        		  	      		               	  */
/* 函数描述  : 通过声速340m/s,计算距离										  */	
/* 输入参数  : time	                                                          */
/* 参数描述  : 发射出去至反射回来的时间                     		              */
/* 返回值    : 距离			                                                  */
/******************************************************************************/
float Get_Dis( unsigned int time)
{
	float dis;
	dis = (float)0.017 * time;
	return dis;
}

/******************************************************************************/
/* 函数名称  : HCSR04_Distance      	        	      		               	  */
/* 函数描述  : 通过超声波测距模块计算前方距离障碍物的距离						  */	
/* 输入参数  : 无	                                                          */
/* 参数描述  : 无      						               		              */
/* 返回值    : 无			                                                  */
/******************************************************************************/
float HCSR04_Distance()
{
	 Trig_Init();
     while(Echo != 1);
     Start_Time();
 	 while(Echo != 0);
     End_Time();
     time = Get_Time();
     dis = Get_Dis(time);
	return dis;
}
 